---
layout: post
title: "빠르고 정확하게, 신사업 FMS 데이터 파이프라인 구축기 - 2"
subtitle: 빠르고 정확하게, 신사업 FMS 데이터 파이프라인 구축기
date: 2022-12-11 09:00:00 +0900
category: data
background: "/img/advanced-airflow-for-databiz/background.jpg"
author: grab
comments: true
tags:
    - data
    - data engineering
    - iot streaming
    - data platform
    - kafka connect
    - aws
---

안녕하세요. 데이터 플랫폼 팀의 그랩입니다.

이번 글은 '빠르고 정확하게, 신사업 FMS 데이터 파이프라인 구축기'의 2편으로 안정적으로 파이프라인을 운영하기 위해 했던 노력들을 소개해 드리려고 합니다.

글을 읽으시면서 궁금한 점들이 있다면 편하게 질문 남겨주시면, 확인 후 답변드리겠습니다.

목차는 아래와 같습니다.  
....

## 5. 견고한 파이프라인을 위한 E2E 테스트 환경 구축하기

본 장에서는 1편에서 소개드린 주요 컴포넌트(Kafka Connect, Lambda 등)을 안정적으로 운영하기 위해 적용한 E2E 테스트에 대해 소개드리겠습니다.

### 데이터 파이프라인에 테스트가 필요한 이유

왜 데이터 파이프라인에서 테스트가 필요할까요? 만약 데이터 파이프라인의 구성요소가 SaaS나 클라우드 서비스로만 구성된다면 테스트가 크게 필요하지 않을 수 있습니다. 하지만 1부에서 다룬 것처럼 Kafka Sink Connector, Lambda 함수 같이 요구사항에 맞는 소프트웨어를 직접 개발해야 한다면 어떨까요? 소프트웨어의 신뢰성을 높이고 잦은 변경과 배포를 가능하도록 하게 테스트를 작성하는 것이 중요할 수 있습니다.

데이터 파이프라인에서 특정 컴포넌트가 제대로 동작하지 않는다면 Downstream 컴포넌트는 당연히 동작을 하지 않고 제대로 된 데이터 변형/적재가 힘들어 집니다. 즉 각 컴포넌트가 SPoF(Single Point of Failure)가 되기 쉽기 때문에 충분히 신뢰할 수 있는 환경을 구성해주는 것이 중요합니다.  
그리고 데이터 파이프라인의 특성상 Input과 Output이 명확합니다. 따라서 테스트 작성이나 결과를 검증하는 과정이 쉬운 편입니다.

데이터 파이프라인에서 많이 언급되는 Data Quality 테스트는 7장에서 더 자세하게 다루도록 하겠습니다.

### E2E 테스트란

소프트웨어를 테스트 할 때 많이 나누는 분류 기준으로 Unit Test(단위 테스트), Integration Test(통합 테스트), E2E Test(종단간 테스트)가 있습니다.

유닛 테스트

-   유닛(Unit)이라는 말 그대로, 가장 작은 단위의 테스트입니다. 단일 기능을 가지는 함수, 클래스의 메서드가 잘 작동하는지 테스트할 때 많이 사용됩니다.
-   가장 간단하고, 직관적이며, 빠르게 실행과 결과를 볼 수 있는 테스트입니다.

통합 테스트

-   통합(Integration)이라는 말 그대로, 여러 요소를 통합한 테스트를 말합니다. 데이터베이스와 연동한 코드가 잘 작동하는지, 여러 함수와 클래스가 엮인 로직이 잘 작동하는지 등을 확인합니다.
-   유닛 테스트보다는 복잡하고 느리지만, 소프트웨어는 결국 여러 코드 로직의 통합이라는 점에서 통합 테스트 역시 중요합니다.

E2E 테스트

-   E2E는 End To End의 약자로, 끝에서 끝, 즉 클라이언트 입장에서 테스트해보는 것입니다.
    예를 들어 Lambda 함수의 Input으로 Event 정보를 넣었을 때 Output으로 S3 객체가 잘 생성되었는지 확인하는 것도 E2E 테스트로 볼 수 있습니다.

-   테스트하는 대상의 Input과 Output이 명확해졌을 때 작성해야 하며 외부 의존성도 함께 구현해서 테스트하게 됩니다. 예를 들어 Lambda 함수의 E2E 테스트를 할 때 S3라는 외부 의존성이 필요합니다.

-   테스트 중 가장 신경써야 할 것이 많지만, 내부의 구현이 변경되도 검증이 유효하며 있고 시나리오에 맞춰 테스트할 수 있어 검증의 폭이 넓다는 장점이 있습니다.

PoC 단계에서는 빠르게 개발을 해야 했고, 데이터 파이프라인을 구성하기 위한 명확한 요구사항이 있다는 점에서 다른 테스트 보단 E2E 테스트를 중심으로 테스트 환경을 구축하였습니다.

### Docker Compose를 통한 E2E 환경 구성

-   Docker-Compose를 통해 데이터 파이프라인을 구성하는 주요 요소들을 도커 컨테이너로 전부 실행
-   소스코드
-   localhost를 통해 테스트할 컴포넌트는 접근이 가능

### Github Submodule을 통한 컴포넌트 별 E2E 테스트

### Github Action을 통한 E2E 테스트 자동화

-   Github Action이란?
-   Github Action의 Checkout을 활용해 Docker Compose 백그라운드로 실행하기
    -   Github Action은 하나의 Job이 하나의 가상환경에서 돌아감
-   Pull Request, Deploy하기 전에 E2E로 검사

## 6. 시뮬레이터를 활용한 실 데이터 기반 부하 테스트

### 실 데이터 기반의 메시지 시뮬레이터

-   MVP 서비스 런칭 전까지 데이터를 처리/저장하는 소프트웨어는 계속해서 데이터가 흘러야 했음
-   메시지 시뮬레이터를 구현해 실데이터 기반으로 메시지를 전송할 수 있도록 제공함
-   병렬 처리, 데이터 번형 전송이 가능하도록 구현

### 부하 테스트

-   부하 테스트 계획 세우기
-   주요하게 확인한 지표
-   부하테스트 진행
    -   차량 데이터 설정
    -   각 프로토콜 메시지를 병렬로 전송
-   부하테스트 결과 정리

## 7. 데이터 신뢰성을 위한 정합성과 무결성 검증하기

### 데이터 정합성/무결성이란?

-   정합성
-   무결성
-   중요한 이유

### 검사할 대상 정의하기

-   유형
    -   원본 데이터에 대한 차량 데이터 이상 현상 검사
    -   마트 테이블의 정합성 검사
    -   마트 테이블의 무결성 검사
-   검사지 만들기

### 정합성/무결성 검사 모니터링 구현하기

-   Airflow 활용
-   프로세스
    -   마트 테이블 무결성 검사는 마트 생성 Dag에서 진행
    -   원본 데이터 이상 여부 검사, 마트 테이블 정합성 검사는 하나의 Dag에서 진행
-   Dag 구현 코드

### 검사 결과 모니터링하기

-   Grafana를 통한 대시보드에서 확인
-   이상이 있는 경우 Slack Alert를 통해 확인

## 8. 마무리

### 남은과제

### 결론
